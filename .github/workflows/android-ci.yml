name: Android CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    strategy:
      matrix:
        api-level: [26, 33]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
      
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Cache build outputs
        uses: actions/cache@v4
        with:
          path: |
            build
            */build
            .gradle
          key: ${{ runner.os }}-build-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-build-
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Check Gradle wrapper
        run: |
          ./gradlew --version
          ./gradlew tasks --all
      
      - name: Build all modules
        run: |
          ./gradlew clean assembleDebug --stacktrace --scan
      
      - name: Run unit tests
        run: |
          ./gradlew test --stacktrace
      
      - name: Run instrumentation tests (API ${{ matrix.api-level }})
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          target: google_apis
          arch: x86_64
          profile: pixel_6
          disable-animations: true
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          script: ./gradlew connectedDebugAndroidTest --stacktrace
      
      - name: Generate test report
        if: always()
        run: |
          ./gradlew testDebugUnitTest --continue
          find . -type f -path "*/build/reports/tests/*" -name "index.html" -exec echo {} \;
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-api-${{ matrix.api-level }}
          path: |
            **/build/reports/tests/
            **/build/test-results/
          retention-days: 7
      
      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: apps/android/build/outputs/apk/debug/*.apk
          retention-days: 14
      
      - name: Analyze APK
        if: github.event_name == 'pull_request'
        run: |
          APK=$(find apps/android/build/outputs/apk/debug -name "*.apk" | head -1)
          if [ -f "$APK" ]; then
            echo "ðŸ“¦ APK Analysis:"
            ls -lh "$APK"
            unzip -l "$APK" | grep "\.so$" || true
          fi

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      
      - name: Grant execute permission
        run: chmod +x gradlew
      
      - name: Run Android Lint
        run: ./gradlew lintDebug --stacktrace
      
      - name: Upload lint reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports
          path: |
            **/build/reports/lint-*.html
            **/build/reports/lint-*.xml
          retention-days: 7

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Dependency Check
        run: |
          ./gradlew dependencyCheckAnalyze --stacktrace || true
      
      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: build/reports/dependency-check-report.html
          retention-days: 7

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build, code-quality]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ—ï¸ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Code Quality**: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
