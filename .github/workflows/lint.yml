name: Lint & Code Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'

jobs:
  detekt:
    name: Detekt Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      
      - name: Grant execute permission
        run: chmod +x gradlew
      
      - name: Run Detekt
        run: |
          ./gradlew detekt --stacktrace || true
      
      - name: Upload Detekt reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detekt-reports
          path: |
            **/build/reports/detekt/
          retention-days: 7
      
      - name: Annotate PR with Detekt findings
        if: github.event_name == 'pull_request'
        uses: github/super-linter@v5
        env:
          VALIDATE_KOTLIN_DETEKT: true
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ktlint:
    name: KtLint Code Style
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      
      - name: Grant execute permission
        run: chmod +x gradlew
      
      - name: Run KtLint
        run: |
          ./gradlew ktlintCheck --stacktrace
      
      - name: Upload KtLint reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ktlint-reports
          path: |
            **/build/reports/ktlint/
          retention-days: 7

  android-lint:
    name: Android Lint
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Grant execute permission
        run: chmod +x gradlew
      
      - name: Run Android Lint
        run: |
          ./gradlew lintDebug --stacktrace
      
      - name: Upload Android Lint reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-lint-reports
          path: |
            **/build/reports/lint-*.html
            **/build/reports/lint-*.xml
          retention-days: 7
      
      - name: Check for critical issues
        run: |
          CRITICAL=$(find . -name "lint-results-*.xml" -exec grep -c 'severity="Error"' {} + || echo 0)
          echo "Critical lint issues: $CRITICAL"
          if [ "$CRITICAL" -gt 0 ]; then
            echo "âš ï¸ Found $CRITICAL critical lint issues"
          fi

  code-coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'
      
      - name: Grant execute permission
        run: chmod +x gradlew
      
      - name: Run tests with coverage
        run: |
          ./gradlew testDebugUnitTestCoverage --stacktrace
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./**/build/reports/jacoco/**/*.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
      
      - name: Generate coverage badge
        run: |
          echo "ðŸ“Š Coverage report generated"
      
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            **/build/reports/jacoco/
          retention-days: 7

  lint-summary:
    name: Lint Summary
    runs-on: ubuntu-latest
    needs: [detekt, ktlint, android-lint, code-coverage]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ” Lint & Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Detekt | ${{ needs.detekt.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| KtLint | ${{ needs.ktlint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Android Lint | ${{ needs.android-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ needs.code-coverage.result }} |" >> $GITHUB_STEP_SUMMARY
