name: CMake Native Build

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'native/**'
      - 'modules/**/src/main/cpp/**'
      - '**/CMakeLists.txt'
      - '.github/workflows/cmake-native.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'native/**'
      - 'modules/**/src/main/cpp/**'
      - '**/CMakeLists.txt'
  workflow_dispatch:

env:
  ANDROID_NDK_VERSION: 'r27'
  CMAKE_VERSION: '3.22.1'

jobs:
  build-native:
    name: Build Native Libraries
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      matrix:
        abi: [arm64-v8a, armeabi-v7a]
        build-type: [Release, Debug]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.ANDROID_NDK_VERSION }}
          add-to-path: true
      
      - name: Install CMake
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build
          cmake --version
      
      - name: Cache CMake build
        uses: actions/cache@v4
        with:
          path: |
            build-native-${{ matrix.abi }}
          key: ${{ runner.os }}-cmake-${{ matrix.abi }}-${{ matrix.build-type }}-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-cmake-${{ matrix.abi }}-
      
      - name: Configure CMake
        run: |
          cmake -B build-native-${{ matrix.abi }} \
                -S native \
                -G Ninja \
                --preset android-${{ matrix.abi == 'arm64-v8a' && 'arm64' || 'armv7' }}-${{ matrix.build-type == 'Release' && 'release' || 'debug' }} \
                -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} \
                -DANDROID_ABI=${{ matrix.abi }} \
                -DANDROID_NDK=$ANDROID_NDK_ROOT
      
      - name: Build native libraries
        run: |
          cmake --build build-native-${{ matrix.abi }} \
                --config ${{ matrix.build-type }} \
                -j $(nproc)
      
      - name: Run unit tests
        if: matrix.build-type == 'Debug'
        run: |
          cd build-native-${{ matrix.abi }}
          ctest --output-on-failure --verbose || true
      
      - name: Upload native libraries
        uses: actions/upload-artifact@v4
        with:
          name: native-libs-${{ matrix.abi }}-${{ matrix.build-type }}
          path: |
            build-native-${{ matrix.abi }}/**/*.so
          retention-days: 7

  microbenchmarks:
    name: Run Microbenchmarks
    runs-on: ubuntu-latest
    needs: build-native
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.ANDROID_NDK_VERSION }}
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build qemu-user
      
      - name: Build benchmarks
        run: |
          cmake -B build-bench \
                -S native/microbench \
                -G Ninja \
                --preset benchmark \
                -DCMAKE_BUILD_TYPE=Release
          
          cmake --build build-bench -j $(nproc)
      
      - name: Run GEMM benchmarks
        run: |
          cd build-bench
          qemu-aarch64 -L $ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/sysroot \
                       ./sme2_vs_neon_gemm || echo "Benchmark requires real hardware"
      
      - name: Generate benchmark report
        run: |
          echo "## ðŸ”¬ Microbenchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Benchmarks executed on: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Note: Full benchmark results require physical ARM hardware." >> $GITHUB_STEP_SUMMARY

  native-summary:
    name: Native Build Summary
    runs-on: ubuntu-latest
    needs: [build-native, microbenchmarks]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ”§ Native Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: ${{ needs.build-native.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Benchmarks**: ${{ needs.microbenchmarks.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ABIs**: arm64-v8a, armeabi-v7a" >> $GITHUB_STEP_SUMMARY
